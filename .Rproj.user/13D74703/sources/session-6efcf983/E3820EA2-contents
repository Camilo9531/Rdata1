#Practico 1 Estadistica III Camilo Agurto


#Valores sin notacion cientifica
options(scipen=999)

#Borrar memoria de trabajo
rm(list=ls())


#Establecer directorio de trabajo
setwd("C:/Users/Camilo Agurto/OneDrive/Desktop/SOCIOLOGIA/ultimo semestre/Estadistica 3/Rproject/Practico 1")

#cargar paquetes

library(corrplot)
library(DescTools)
library(ggstatsplot)
library(naniar)
library(summarytools)
library(sjlabelled)
library(readr)
library(dplyr)
library(haven)
library(sjPlot)
library(sjmisc)
library(tidyverse)
library(ggplot2)
library(psych)
library(stargazer)
library(car)

EBS <- read_dta("C:/Users/Camilo Agurto/OneDrive/Desktop/SOCIOLOGIA/ultimo semestre/Estadistica 3/Rproject/Practico 1/base de datos original/Base de datos EBS 2021 STATA.dta")

#Explorar base de datos
names(EBS)
dim(EBS)
view(EBS)
#Seleccion de variables

EBS <- select(EBS,folio, region, zona, sexo, l1, l6, a3_1, a3_2a,
              a3_2b, a3_3, a3_4, a3_5, a3_6, a3_7, a3_8, a3_9)

frq(EBS$region)
frq(EBS$zona)
frq(EBS$sexo)
frq(EBS$l1)#edad
frq(EBS$l6)#Grado academico alcanzado ##tiene nulos##
frq(EBS$a3_1)#satisfaccion con el nivel educacional logrado
frq(EBS$a3_2a)#satisfaccion con el trabajo actual ##tiene nulos##
frq(EBS$a3_2b)#satisfaccion con su ultimo trabajo ##tiene nulos##
frq(EBS$a3_3)#satisfaccion con los ingresos
frq(EBS$a3_4)#satisfaccion con el tiempo entre trabajo y vida personal ##tiene nulos##
frq(EBS$a3_5)#satisfaccion con vida social
frq(EBS$a3_6)#satisfaccion con la salud
frq(EBS$a3_7)#satisfaccion con la vivienda
frq(EBS$a3_8)#satisfaccion con la situacion medioambiental
frq(EBS$a3_9)#satisfaccin con la seguridad comuna o localidad


#Construccion de variables
#Bienestar_sum
columnas <- c("a3_1", "a3_2a", "a3_2b", "a3_3", "a3_4", "a3_5", "a3_6", "a3_7", "a3_8", "a3_9")
EBS$Bienestar_sum <- rowSums(EBS[columnas],na.rm=TRUE)
frq(EBS$Bienestar_sum)

#Bienestar_mean

EBS$Bienestar_mean <- rowMeans(EBS[columnas],na.rm=TRUE)
frq(EBS$Bienestar_mean)

#Tramos etarios

EBS %>% 
  mutate(grupos_edad = case_when(l1 >= 18 & l1 <36 ~ "Adulto joven",
                                 l1 >= 36 & l1 <65 ~ "Adulto",
                                 l1 >= 65  ~ "Adulto mayor",
                                 TRUE ~ NA))
EBS <- EBS %>% 
  mutate(grupos_edad = case_when(l1 >= 18 & l1 <36 ~ "Adulto joven",
                                 l1 >= 36 & l1 <65 ~ "Adulto",
                                 l1 >= 65  ~ "Adulto mayor",
                                 TRUE ~ NA))

#variable univ

frq(EBS$l6)

EBS <- EBS %>%
  mutate(univ = case_when(
    l6 %in% c(12, 13, 14, 15, 16, 17) ~ 1,
    TRUE ~ 0
  )) %>%
  drop_na(univ)

head(EBS$univ)
frq(EBS$univ)

#variable metropo
frq(EBS$region)

EBS <- EBS %>%
  mutate(metropo = case_when(
    region %in% c(13) ~ 1,
    TRUE ~ 0
  ))
head(EBS$metropo)
frq(EBS$metropo)

#seleccion variables de interes

EBS <- select(EBS,folio, region, sexo, Bienestar_sum, Bienestar_mean, l6,
              grupos_edad, univ, metropo)

# Creacion de tabla que de cuenta de casos perdidos

tabla_nulos <- miss_var_summary(EBS)
print(tabla_nulos)

#Base de datos solo con la informacion de regiones distintas a la metropolitana

EBS_NOMETRO <- EBS %>% filter(metropo==0)

#Estadisticos descriptivos 
frq(EBS_NOMETRO$region)
describe(EBS_NOMETRO$region)
describe(EBS_NOMETRO$sexo)
frq((EBS_NOMETRO$sexo))
describe(EBS_NOMETRO$Bienestar_sum)
describe(EBS_NOMETRO$Bienestar_mean)
describe(EBS_NOMETRO$l6)
frq(EBS_NOMETRO$grupos_edad)
describe(EBS_NOMETRO$univ)
frq(EBS_NOMETRO$univ)
print(dfSummary(EBS_NOMETRO[,c("region","sexo","Bienestar_sum","Bienestar_mean","l6","grupos_edad","univ")], headings = FALSE, method = "render"))
view(dfSummary(EBS_NOMETRO, headings=FALSE))

# Comparar media bienestar_sum segun sexo, region, grupos_edad

#sexo
tapply(EBS_NOMETRO$Bienestar_sum, EBS_NOMETRO$sexo, mean)

#region
tapply(EBS_NOMETRO$Bienestar_sum, EBS_NOMETRO$region, mean)

#grupos_edad
tapply(EBS_NOMETRO$Bienestar_sum, EBS_NOMETRO$grupos_edad, mean)

#intervalos de confianza
MeanCI(EBS_NOMETRO$Bienestar_sum, conf.level = 0.95)
MeanCI(EBS_NOMETRO$Bienestar_mean, conf.level = 0.95)

#Analisis de correlacion 

#Bienestar_sum y Bienestar_mean

X <- (EBS_NOMETRO$Bienestar_sum)
Y <- (EBS_NOMETRO$Bienestar_mean)

# Cálculo de las medias de X e Y
x_mean <- mean(X)
y_mean <- mean(Y)

# Cálculo del numerador de la fórmula
numerator <- sum((X - x_mean) * (Y - y_mean))

# Cálculo de los denominadores de la fórmula
denominator_x <- sqrt(sum((X - x_mean)^2))
denominator_y <- sqrt(sum((Y - y_mean)^2))

# Cálculo del coeficiente de correlación de Pearson
r <- numerator / (denominator_x * denominator_y)

# Mostrar el resultado
r

cor(EBS_NOMETRO[,c("Bienestar_sum","Bienestar_mean")], use="complete.obs")
correlacion1<- cor(EBS_NOMETRO[,c("Bienestar_sum","Bienestar_mean")], use="complete.obs")
corrplot(correlacion1, method = 'number', type = 'upper')


#Bienestar_sum y l6

X <- EBS_NOMETRO$Bienestar_sum[!is.na(EBS_NOMETRO$Bienestar_sum) & !is.na(EBS_NOMETRO$l6)]
Y <- EBS_NOMETRO$l6[!is.na(EBS_NOMETRO$Bienestar_sum) & !is.na(EBS_NOMETRO$l6)]


# Cálculo de las medias de X e Y
x_mean <- mean(X)
y_mean <- mean(Y)

# Cálculo del numerador de la fórmula
numerator <- sum((X - x_mean) * (Y - y_mean))

# Cálculo de los denominadores de la fórmula
denominator_x <- sqrt(sum((X - x_mean)^2))
denominator_y <- sqrt(sum((Y - y_mean)^2))

# Cálculo del coeficiente de correlación de Pearson
r2 <- numerator / (denominator_x * denominator_y)

# Mostrar el resultado
r2

cor(EBS_NOMETRO[,c("Bienestar_sum","l6")], use="complete.obs")
correlacion2<- cor(EBS_NOMETRO[,c("Bienestar_sum","l6")], use="complete.obs")
corrplot(correlacion2, method = 'number', type = 'upper')


# Gráfico de dispersión x = "Bienestar_sum" y = "Bienestar_mean"
ggplot(EBS_NOMETRO, aes(x = Bienestar_sum, y = Bienestar_mean)) +
  geom_point() +
  labs(x = "Bienestar_sum", y = "Bienestar_mean")

#Test de hipotesis: H0, no hay una correlacion significativa entre las variables
#h1, hay una correlacion significativa entre las variables

test_correlacion <- cor.test(EBS_NOMETRO$Bienestar_sum, EBS_NOMETRO$Bienestar_mean)
test_correlacion$p.value
# Gráfico de dispersión x = "l6", y = "Bienestar_sum"

EBS_NOMETRO <- EBS_NOMETRO %>%
  filter(!is.na(l6))
ggplot(EBS_NOMETRO, aes(x = l6, y = Bienestar_sum)) +
  geom_point() +
  labs(x = "l6", y = "Bienestar_sum")

#Test de hipotesis: H0, no hay una correlacion significativa entre las variables
#h1, hay una correlacion significativa entre las variables

test_correlacion2 <- cor.test(EBS_NOMETRO$Bienestar_sum, EBS_NOMETRO$l6)
test_correlacion2$p.value



